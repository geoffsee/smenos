#!/usr/bin/env sh

set -e

# Enforce API key or endpoint requirement
if [ -z "$OPENAI_API_KEY" ] && [ -z "$OPENAI_API_ENDPOINT" ]; then
    echo "Error: Either OPENAI_API_KEY or OPENAI_API_ENDPOINT must be set"
    echo ""
    echo "Usage:"
    echo "  export OPENAI_API_KEY='your-api-key'"
    echo "  ./smenos [arguments]"
    echo ""
    echo "Or:"
    echo "  export OPENAI_API_ENDPOINT='your-endpoint-url'"
    echo "  ./smenos [arguments]"
    exit 1
fi

# Configuration
IMAGE_NAME="smenos:latest"
TEMP_VOLUME=$(mktemp -d)

# Cleanup function
cleanup() {
    echo "Cleaning up temporary volume: $TEMP_VOLUME"
    rm -rf "$TEMP_VOLUME"
}

trap cleanup EXIT

# Build the container
echo "Building container image..."
docker build -f Containerfile -t "$IMAGE_NAME" .

# Extract /app contents from the container to temp volume
echo "Extracting /app contents to temporary volume..."
docker create --name smenos-temp "$IMAGE_NAME" > /dev/null
docker cp smenos-temp:/app/. "$TEMP_VOLUME/"
docker rm smenos-temp > /dev/null

# Build environment variables for docker run
ENV_FLAGS=""
if [ -n "$OPENAI_API_KEY" ]; then
    ENV_FLAGS="$ENV_FLAGS -e OPENAI_API_KEY"
fi
if [ -n "$OPENAI_API_ENDPOINT" ]; then
    ENV_FLAGS="$ENV_FLAGS -e OPENAI_API_ENDPOINT"
fi

# Run the container with temp volume mounted at /app
echo "Running container with temporary volume mounted at: $TEMP_VOLUME"
docker run --rm -it \
    $ENV_FLAGS \
    -v "$TEMP_VOLUME:/app" \
    "$IMAGE_NAME" "$@"
