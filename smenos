#!/usr/bin/env sh

set -e

check_binary() {
    command -v "$1" >/dev/null 2>&1
    return $?
}

# Ensure Rust is installed
if ! check_binary cargo; then
    echo "Rust not found — installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

    # Source cargo environment after install
    if [ -f "$HOME/.cargo/env" ]; then
        . "$HOME/.cargo/env"
    fi

    if ! check_binary cargo; then
        echo "Cargo still not found after Rust install — aborting."
        exit 1
    fi
fi

# Ensure cargo-binstall is installed
if ! check_binary cargo-binstall; then
    echo "cargo-binstall not found — installing..."
    curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

    # Source any cargo env changes again
    if [ -f "$HOME/.cargo/env" ]; then
        . "$HOME/.cargo/env"
    fi

    if ! check_binary cargo-binstall; then
        echo "Failed to install cargo-binstall — aborting."
        exit 1
    fi
fi

# Ensure spec-ai is installed
if ! check_binary spec-ai; then
    echo "Installing spec-ai..."
    if ! cargo binstall spec-ai; then
        echo "Failed to install spec-ai"
        exit 1
    fi
fi

# Ensure muxox is installed
if ! check_binary muxox; then
    echo "Installing muxox..."
    if ! cargo binstall muxox; then
        echo "Failed to install muxox"
        exit 1
    fi
fi

echo "Starting muxox..."
exec muxox
